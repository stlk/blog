<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="/public/favicon.ico" rel="shortcut icon" type="image/x-icon">
    <link href="http://gmpg.org/xfn/11" rel="profile">

    <title>
      Visualizing Strava activites with Folium and Jupyter Notebook &middot; 
      Zápisník Josefa Rouska
    </title>

    <meta content="Zápisník Josefa Rouska" property="og:site_name">
    
      <meta content="Visualizing Strava activites with Folium and Jupyter Notebook" property="og:title">
    
    
      <meta content="article" property="og:type">
      <meta property="article:author" content="https://www.facebook.com/josef.rousek" />
    
    
      <meta name="description" content="Few days ago I participated in my first race ever! It was short triathlon called Slapský triatlon. My friend was talking me into it for almost two years. The swimming is 500m, cycling is 34km and running is 4.5km. I don’t swim or run that much but I was pretty sure I can handle this. I was pretty confident with cycling which turned out to be a mistake. I was happy with the result overall. I wasn’t last. I’m pretty satisfied with swimming and running, but I could push a bit harder on the bike. The result is that I have some interesting data I can play around.

">
      <meta content="Few days ago I participated in my first race ever! It was short triathlon called Slapský triatlon. My friend was talking me into it for almost two years. The swimming is 500m, cycling is 34km and running is 4.5km. I don’t swim or run that much but I was pretty sure I can handle this. I was pretty confident with cycling which turned out to be a mistake. I was happy with the result overall. I wasn’t last. I’m pretty satisfied with swimming and running, but I could push a bit harder on the bike. The result is that I have some interesting data I can play around.

" property="og:description">
    
    
      <meta content="https://blog.rousek.name/2018/08/05/visualizing-strava-activities-with-folium-and-jupyter-notebook/" property="og:url">
    
    
      <meta content="2018-08-05T00:00:00-05:00" property="article:published_time">
    
    

    <!-- CSS -->
    <link rel="stylesheet" href="/public/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,400italic,400,600,700|Abril+Fatface&subset=latin,latin-ext">

    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/public/favicon.png">

    <!-- RSS -->
    <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
  </head>
  <body>

    <header class="masthead">
      <div class="masthead-inner">
        <h1><a href="/">Zápisník Josefa Rouska</a></h1>
        <p class="lead">Python a React.js programátor, zaměřený na Shopify integrace</p>

        <div class="colophon">
          <ul class="colophon-links">
            <li><a href="https://rousek.name/">about</a></li>
            <li><a href="https://github.com/stlk">github</a></li>
            <li><a href="https://twitter.com/josefrousek">twitter</a></li>
          </ul>
        </div>

      </div>
    </header>

    <div class="content container">
      <div class="post">
  <h1>Visualizing Strava activites with Folium and Jupyter Notebook</h1>
  <span class="post-date">05 Aug 2018</span>
  <p>Few days ago I participated in my first race ever! It was short triathlon called <a href="https://slapsky-triatlon.webnode.cz/">Slapský triatlon</a>. My friend was talking me into it for almost two years. The swimming is 500m, cycling is 34km and running is 4.5km. I don’t swim or run that much but I was pretty sure I can handle this. I was pretty confident with cycling which turned out to be a mistake. I was happy with the result overall. I wasn’t last. I’m pretty satisfied with swimming and running, but I could push a bit harder on the bike. The result is that I have some interesting data I can play around.</p>

<iframe src="/public/slapsky-triatlon.html" style="width: 100%; height: 400px;border:none;"></iframe>
<p style="text-align:center;color: #555;font-size:0.8rem;">Speed visualization of the cycling part. Ranging from deep blue for slowest to deep red for fastest.</p>

<p>When exploring the data I always use Jupyter Notebook and Folium. Folium lets you generate <code class="highlighter-rouge">leaflet.js</code> maps directly from Python.</p>

<p>Getting data from Strava is pretty simple. First, you need your Access Token. You can get them in <a href="https://www.strava.com/settings/api">My API Application</a> section in Settings.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">stravalib.client</span> <span class="kn">import</span> <span class="n">Client</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">access_token</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">STRAVA_ACCESS_TOKEN</span><span class="o">&gt;</span><span class="p">)</span>

<span class="n">types</span> <span class="o">=</span> <span class="p">[</span><span class="s">'time'</span><span class="p">,</span> <span class="s">'distance'</span><span class="p">,</span> <span class="s">'latlng'</span><span class="p">,</span> <span class="s">'altitude'</span><span class="p">,</span> <span class="s">'velocity_smooth'</span><span class="p">,</span> <span class="s">'moving'</span><span class="p">,</span> <span class="s">'grade_smooth'</span><span class="p">]</span>
<span class="n">streams</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_activity_streams</span><span class="p">(</span><span class="o">&lt;</span><span class="n">ACTIVITY_ID</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">types</span><span class="o">=</span><span class="n">types</span><span class="p">)</span>
</code></pre></div></div>

<p>Then to get stream data use <code class="highlighter-rouge">streams['altitude'].data</code>. To make resulting map look a bit more smooth we need to group similar velocity data points. This does pretty good job.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">locations</span> <span class="o">=</span> <span class="n">streams</span><span class="p">[</span><span class="s">'latlng'</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">velocities</span> <span class="o">=</span> <span class="n">streams</span><span class="p">[</span><span class="s">'velocity_smooth'</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

<span class="n">data</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">locations</span><span class="p">,</span> <span class="n">velocities</span><span class="p">)</span>

<span class="n">groups</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">last_velocity</span> <span class="o">=</span> <span class="bp">None</span>
<span class="k">for</span> <span class="n">location</span><span class="p">,</span> <span class="n">velocity</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">last_velocity</span> <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">last_velocity</span><span class="p">)</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">(</span><span class="n">velocity</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">0.4</span><span class="p">:</span>
        <span class="n">groups</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s">'velocity'</span><span class="p">:</span> <span class="n">velocity</span><span class="p">,</span> <span class="s">'velocities'</span><span class="p">:</span> <span class="p">[],</span> <span class="s">'locations'</span><span class="p">:</span> <span class="p">[]})</span>
    <span class="n">groups</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:][</span><span class="mi">0</span><span class="p">][</span><span class="s">'locations'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>
    <span class="n">groups</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:][</span><span class="mi">0</span><span class="p">][</span><span class="s">'velocities'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">velocity</span><span class="p">)</span>
    <span class="n">last_velocity</span> <span class="o">=</span> <span class="n">velocity</span>

<span class="kn">import</span> <span class="nn">statistics</span>

<span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
    <span class="n">group</span><span class="p">[</span><span class="s">'velocity'</span><span class="p">]</span> <span class="o">=</span> <span class="n">statistics</span><span class="o">.</span><span class="n">median_high</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s">'velocities'</span><span class="p">])</span>
</code></pre></div></div>

<p>To correctly colorize segments we need to normalize and map the values to colors. Luckily <code class="highlighter-rouge">matplotlib</code> does this for us with the exception of converting the color to hex. First, we will use <code class="highlighter-rouge">Normalize</code> to, well, normalize the value and then <a href="https://matplotlib.org/tutorials/colors/colormaps.html">colormap</a> value to color. The last step is converting rgb 0.0 - 1.0 to hex.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">convert_to_hex</span><span class="p">(</span><span class="n">rgba_color</span><span class="p">):</span>
    <span class="n">red</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">rgba_color</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">255</span><span class="p">)))[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>
    <span class="n">green</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">rgba_color</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">255</span><span class="p">)))[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>
    <span class="n">blue</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">rgba_color</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mi">255</span><span class="p">)))[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">blue</span><span class="o">==</span><span class="s">'0'</span><span class="p">:</span>
        <span class="n">blue</span> <span class="o">=</span> <span class="s">'00'</span>
    <span class="k">if</span> <span class="n">red</span><span class="o">==</span><span class="s">'0'</span><span class="p">:</span>
        <span class="n">red</span> <span class="o">=</span> <span class="s">'00'</span>
    <span class="k">if</span> <span class="n">green</span><span class="o">==</span><span class="s">'0'</span><span class="p">:</span>
        <span class="n">green</span><span class="o">=</span><span class="s">'00'</span>

    <span class="k">return</span> <span class="s">'#'</span><span class="o">+</span> <span class="n">red</span> <span class="o">+</span> <span class="n">green</span> <span class="o">+</span> <span class="n">blue</span>

<span class="kn">import</span> <span class="nn">matplotlib.cm</span> <span class="k">as</span> <span class="n">cm</span>
<span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">Normalize</span>

<span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">bwr</span>
<span class="n">norm</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">velocities</span><span class="p">),</span> <span class="n">vmax</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">velocities</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">colorize</span><span class="p">(</span><span class="n">grade</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">convert_to_hex</span><span class="p">(</span><span class="n">cmap</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">grade</span><span class="p">)))</span>
</code></pre></div></div>

<p>With grouped data and correct color the only thing we need to do is generate <code class="highlighter-rouge">PolyLine</code>s for each group and display map.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">folium</span>

<span class="n">m</span> <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="p">[</span><span class="mf">49.7947117</span><span class="p">,</span><span class="mf">14.3916288</span><span class="p">],</span> <span class="n">tiles</span><span class="o">=</span><span class="s">'Stamen Toner'</span><span class="p">,</span> <span class="n">zoom_start</span><span class="o">=</span><span class="mf">12.2</span><span class="p">)</span>

<span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
    <span class="n">folium</span><span class="o">.</span><span class="n">PolyLine</span><span class="p">(</span>
        <span class="n">group</span><span class="p">[</span><span class="s">'locations'</span><span class="p">],</span>
        <span class="n">weight</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="n">colorize</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s">'velocity'</span><span class="p">])</span>
    <span class="p">)</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

<span class="n">m</span>
</code></pre></div></div>

<p>You can see the entire notebook on <a href="https://nbviewer.jupyter.org/github/stlk/strava-playground/blob/master/Strava%20route%20visualizer.ipynb">nbviewer.jupyter.org</a>. Here are my <a href="https://www.strava.com/activities/1732801109">ride</a> and <a href="https://www.strava.com/activities/1732871895">run</a> if you want to explore my activities on Strava.</p>

</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2020/03/28/my-2019/">
            My year 2019
            <small>28 Mar 2020</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2020/03/07/speed-up-reports-using-materialized-views/">
            Speed up your reports using materialized views
            <small>07 Mar 2020</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2020/02/01/chrome-80-iframes-and-cookies/">
            Chrome 80, iframes and cookies
            <small>01 Feb 2020</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

    </div>


    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-485461-11"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() { dataLayer.push(arguments); }
      gtag('js', new Date());

      gtag('config', 'UA-485461-11');
    </script>



  </body>
</html>
