<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="/public/favicon.ico" rel="shortcut icon" type="image/x-icon">
    <link href="http://gmpg.org/xfn/11" rel="profile">

    <title>
      Export Rails model data as CSV &middot; 
      Zápisník Josefa Rouska
    </title>

    <meta content="Zápisník Josefa Rouska" property="og:site_name">
    
      <meta content="Export Rails model data as CSV" property="og:title">
    
    
      <meta content="article" property="og:type">
      <meta property="article:author" content="https://www.facebook.com/josef.rousek" />
    
    
      <meta name="description" content="I needed to allow my customer to export a bunch of tables. After some digging, I found a pretty neat solution.

">
      <meta content="I needed to allow my customer to export a bunch of tables. After some digging, I found a pretty neat solution.

" property="og:description">
    
    
      <meta content="https://blog.rousek.name/2018/03/01/export-rails-model-data-as-csv/" property="og:url">
    
    
      <meta content="2018-03-01T00:00:00-06:00" property="article:published_time">
    
    

    <!-- CSS -->
    <link rel="stylesheet" href="/public/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,400italic,400,600,700|Abril+Fatface&subset=latin,latin-ext">

    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/public/favicon.png">

    <!-- RSS -->
    <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
  </head>
  <body>

    <header class="masthead">
      <div class="masthead-inner">
        <h1><a href="/">Zápisník Josefa Rouska</a></h1>
        <p class="lead">Python a React.js programátor, zaměřený na Shopify integrace</p>

        <div class="colophon">
          <ul class="colophon-links">
            <li><a href="https://rousek.name/">about</a></li>
            <li><a href="https://github.com/stlk">github</a></li>
            <li><a href="https://twitter.com/josefrousek">twitter</a></li>
          </ul>
        </div>

      </div>
    </header>

    <div class="content container">
      <div class="post">
  <h1>Export Rails model data as CSV</h1>
  <span class="post-date">01 Mar 2018</span>
  <p>I needed to allow my customer to export a bunch of tables. After some digging, I found a pretty neat solution.</p>

<p>Let’s say we have a <code class="highlighter-rouge">Customer</code>, <code class="highlighter-rouge">Order</code> and <code class="highlighter-rouge">OrderItem</code> model. We want to allow the user to download exported data as CSV in a single zip file. To generate CSV from the model we can use following code.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Customer</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">to_csv</span>
    <span class="n">attributes</span> <span class="o">=</span> <span class="sx">%w{id name email address}</span>

    <span class="no">CSV</span><span class="p">.</span><span class="nf">generate</span><span class="p">(</span><span class="ss">headers: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">csv</span><span class="o">|</span>
      <span class="n">csv</span> <span class="o">&lt;&lt;</span> <span class="n">attributes</span>

      <span class="n">all</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">treatment</span><span class="o">|</span>
        <span class="n">csv</span> <span class="o">&lt;&lt;</span> <span class="n">attributes</span><span class="p">.</span><span class="nf">map</span><span class="p">{</span> <span class="o">|</span><span class="kp">attr</span><span class="o">|</span> <span class="n">treatment</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="kp">attr</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>Then we need only to package up the files in <code class="highlighter-rouge">zip</code> file and send it to the user.</p>

<p>We will use a gem called <code class="highlighter-rouge">rubyzip</code>. To instal it add this to your <code class="highlighter-rouge">Gemfile</code>:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">gem</span> <span class="s1">'rubyzip'</span><span class="p">,</span> <span class="ss">require: </span><span class="s1">'zip'</span></code></pre></figure>

<p>We can write text files directly to an archived file using <code class="highlighter-rouge">puts</code>, so all we need to do is to use <code class="highlighter-rouge">Tempfile</code> as our backing file.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">Admin</span>
  <span class="k">class</span> <span class="nc">ExportsController</span> <span class="o">&lt;</span> <span class="no">Admin</span><span class="o">::</span><span class="no">ApplicationController</span>
    <span class="k">def</span> <span class="nf">download_export</span>

      <span class="n">tables</span> <span class="o">=</span> <span class="p">[</span>
        <span class="no">Customer</span><span class="p">,</span>
        <span class="no">Order</span><span class="p">,</span>
        <span class="no">OrderItem</span><span class="p">,</span>
      <span class="p">]</span>

      <span class="n">filename</span> <span class="o">=</span> <span class="s2">"shop-export-</span><span class="si">#{</span><span class="no">Date</span><span class="p">.</span><span class="nf">today</span><span class="si">}</span><span class="s2">.zip"</span>
      <span class="n">temp_file</span> <span class="o">=</span> <span class="no">Tempfile</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

      <span class="k">begin</span>
        <span class="o">::</span><span class="no">Zip</span><span class="o">::</span><span class="no">OutputStream</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">temp_file</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">zos</span><span class="o">|</span>
          <span class="n">tables</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">table</span><span class="o">|</span>
            <span class="n">zos</span><span class="p">.</span><span class="nf">put_next_entry</span> <span class="s2">"</span><span class="si">#{</span><span class="n">table</span><span class="p">.</span><span class="nf">name</span><span class="p">.</span><span class="nf">downcase</span><span class="si">}</span><span class="s2">.csv"</span>
            <span class="n">zos</span><span class="p">.</span><span class="nf">puts</span> <span class="n">table</span><span class="p">.</span><span class="nf">to_csv</span>
          <span class="k">end</span>
        <span class="k">end</span>

        <span class="n">zip_data</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">temp_file</span><span class="p">.</span><span class="nf">path</span><span class="p">)</span>
        <span class="n">send_data</span><span class="p">(</span><span class="n">zip_data</span><span class="p">,</span> <span class="ss">type: </span><span class="s1">'application/zip'</span><span class="p">,</span> <span class="ss">filename: </span><span class="n">filename</span><span class="p">)</span>
      <span class="k">ensure</span>
        <span class="n">temp_file</span><span class="p">.</span><span class="nf">close</span>
        <span class="n">temp_file</span><span class="p">.</span><span class="nf">unlink</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>


</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2020/07/16/pipenv-is-great/">
            Pipenv is great
            <small>16 Jul 2020</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2020/03/28/my-2019/">
            My year 2019
            <small>28 Mar 2020</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2020/03/07/speed-up-reports-using-materialized-views/">
            Speed up your reports using materialized views
            <small>07 Mar 2020</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

    </div>


    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-485461-11"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() { dataLayer.push(arguments); }
      gtag('js', new Date());

      gtag('config', 'UA-485461-11');
    </script>



  </body>
</html>
