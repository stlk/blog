<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="/public/favicon.ico" rel="shortcut icon" type="image/x-icon">
    <link href="http://gmpg.org/xfn/11" rel="profile">

    <title>
      Local state management pomocí Apollo &middot; 
      Zápisník Josefa Rouska
    </title>

    <meta content="Zápisník Josefa Rouska" property="og:site_name">
    
      <meta content="Local state management pomocí Apollo" property="og:title">
    
    
      <meta content="article" property="og:type">
      <meta property="article:author" content="https://www.facebook.com/josef.rousek" />
    
    
      <meta name="description" content="Apollo je sada nástrojů pro práci s GraphQL od tvůrců Meteor.js. Apollo Client slouží k napojení UI na data, Apollo Engine na infrastrukturu a tooling a nakonec Apollo Server pro zpřístupnění REST API pomocí GraphQL.
">
      <meta content="Apollo je sada nástrojů pro práci s GraphQL od tvůrců Meteor.js. Apollo Client slouží k napojení UI na data, Apollo Engine na infrastrukturu a tooling a nakonec Apollo Server pro zpřístupnění REST API pomocí GraphQL.
" property="og:description">
    
    
      <meta content="https://blog.rousek.name/2018/06/08/local-state-management-pomoci-apollo/" property="og:url">
    
    
      <meta content="2018-06-08T00:00:00-05:00" property="article:published_time">
    
    

    <!-- CSS -->
    <link rel="stylesheet" href="/public/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,400italic,400,600,700|Abril+Fatface&subset=latin,latin-ext">

    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/public/favicon.png">

    <!-- RSS -->
    <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
  </head>
  <body>

    <header class="masthead">
      <div class="masthead-inner">
        <h1><a href="/">Zápisník Josefa Rouska</a></h1>
        <p class="lead">Python a React.js programátor, zaměřený na Shopify integrace</p>

        <div class="colophon">
          <ul class="colophon-links">
            <li><a href="https://rousek.name/">about</a></li>
            <li><a href="https://github.com/stlk">github</a></li>
            <li><a href="https://twitter.com/josefrousek">twitter</a></li>
          </ul>
        </div>

      </div>
    </header>

    <div class="content container">
      <div class="post">
  <h1>Local state management pomocí Apollo</h1>
  <span class="post-date">08 Jun 2018</span>
  <p>Apollo je sada nástrojů pro práci s GraphQL od tvůrců Meteor.js. Apollo Client slouží k napojení UI na data, Apollo Engine na infrastrukturu a tooling a nakonec Apollo Server pro zpřístupnění REST API pomocí GraphQL.</p>

<p>V tomto článku bych se rád zaměřil na velmi užitečnou část zvanou <a href="https://github.com/apollographql/apollo-link-state">apollo-link-state</a>. Když používám <a href="https://www.apollographql.com/docs/react/essentials/get-started.html#apollo-boost">Apollo Client</a>, tak mám vyřešenou práci s API. V aplikaci je ale vždy nějaký lokální stav, s jehož správou mi Apollo Client může pomoci.</p>

<p>Běžně se pro uchování lokálního stavu používá Redux nebo MobX. S pomocí <code class="language-plaintext highlighter-rouge">apollo-link-state</code> je nově možné použít cache Apollo Clienta jako úložiště pro všechna naše data. Pro čtení nebo zápis lokálního stavu použijeme queries a mutations jako bychom pracovali s daty na serveru.</p>

<p>Začít ukládat stav pomocí <code class="language-plaintext highlighter-rouge">apollo-link-state</code> je velmi jednoduché. Jako základ používám <a href="https://www.apollographql.com/docs/react/essentials/get-started.html#apollo-boost">apollo-boost</a>. <code class="language-plaintext highlighter-rouge">apollo-boost</code> je balíček apollo knihoven, který zahrnuje i <code class="language-plaintext highlighter-rouge">apollo-link-state</code>. Při inicializaci klienta nastavím <code class="language-plaintext highlighter-rouge">clientState</code> a vyplním výchozí hodnoty.</p>

<figure class="highlight"><pre><code class="language-jsx" data-lang="jsx"><span class="k">import</span> <span class="nx">ApolloClient</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">apollo-boost</span><span class="dl">"</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ApolloClient</span><span class="p">({</span>
  <span class="na">uri</span><span class="p">:</span> <span class="dl">""</span><span class="p">,</span>
  <span class="na">clientState</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">defaults</span><span class="p">:</span> <span class="p">{</span> <span class="na">expanded</span><span class="p">:</span> <span class="kc">false</span> <span class="p">},</span>
    <span class="na">resolvers</span><span class="p">:</span> <span class="p">{}</span>
  <span class="p">}</span>
<span class="p">});</span></code></pre></figure>

<p><code class="language-plaintext highlighter-rouge">clientState</code> přijímá i parametr <code class="language-plaintext highlighter-rouge">typeDefs</code>. Toto schéma se nepoužívá pro validaci jako na serveru, protože knihovna <code class="language-plaintext highlighter-rouge">graphql-js</code> by výrazně zvedla velikost výsledného balíku. Client-side schéma se používá v Apollo DevTools, kde je možné schéma prozkoumat.</p>

<p>Pro čtení dat pak stačí použít GraphQL query s direktivou <code class="language-plaintext highlighter-rouge">@client</code>. Na stejném principu fungují ostatní Apollo Link knihovny, např. <code class="language-plaintext highlighter-rouge">apollo-link-rest</code>. Ta používá <code class="language-plaintext highlighter-rouge">@rest</code> direktivu pro označení polí, která by měla být načtena z REST endpointu. Direktivy <code class="language-plaintext highlighter-rouge">@client</code> a <code class="language-plaintext highlighter-rouge">@rest</code> nemění podobu dat, jen určují odkud se data načítají.</p>

<figure class="highlight"><pre><code class="language-jsx" data-lang="jsx"><span class="k">import</span> <span class="p">{</span> <span class="nx">Query</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">react-apollo</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">gql</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">apollo-boost</span><span class="dl">"</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">SECTION_QUERY</span> <span class="o">=</span> <span class="nx">gql</span><span class="s2">`
  {
    expanded @client
  }
`</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">Expander</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">(</span>
  <span class="p">&lt;</span><span class="nc">Query</span> <span class="na">query</span><span class="p">=</span><span class="si">{</span><span class="nx">SECTION_QUERY</span><span class="si">}</span><span class="p">&gt;</span>
    <span class="si">{</span><span class="p">({</span> <span class="nx">data</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">expanded</span> <span class="p">?</span> <span class="dl">"</span><span class="s2">expanded</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">collapsed</span><span class="dl">"</span><span class="p">)</span><span class="si">}</span>
  <span class="p">&lt;/</span><span class="nc">Query</span><span class="p">&gt;</span>
<span class="p">);</span></code></pre></figure>

<p>Zbýva vyřešit zápis dat. Zde jsou na výběr dvě možnosti. První je zápis přímo do cache použitím <code class="language-plaintext highlighter-rouge">client.writeData</code> v komponentách <code class="language-plaintext highlighter-rouge">ApolloConsumer</code>, nebo <code class="language-plaintext highlighter-rouge">Query</code>. Přímý zápis je vhodný pro jednorázové zápisy nezávislé na datech uložených v cache. Druhá možnost je Mutation, volající client-side resolver. Resolver může pracovat s daty v cache, hodí se tedy např. na přidávání položek do seznamu nebo přepínání hodnoty. Přímý zápis bych přirovnal k <code class="language-plaintext highlighter-rouge">setState</code>, zatímco resolver připomíná Redux.</p>

<figure class="highlight"><pre><code class="language-jsx" data-lang="jsx"><span class="k">import</span> <span class="p">{</span> <span class="nx">ApolloConsumer</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">react-apollo</span><span class="dl">"</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">expand</span> <span class="o">=</span> <span class="nx">client</span> <span class="o">=&gt;</span>
  <span class="nx">client</span><span class="p">.</span><span class="nx">writeData</span><span class="p">({</span>
    <span class="na">data</span><span class="p">:</span> <span class="p">{</span> <span class="na">expanded</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}</span>
  <span class="p">});</span>

<span class="k">export</span> <span class="k">default</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">(</span>
  <span class="p">&lt;</span><span class="nc">ApolloConsumer</span><span class="p">&gt;</span>
    <span class="si">{</span><span class="nx">client</span> <span class="o">=&gt;</span> <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick</span><span class="p">=</span><span class="si">{</span><span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">expand</span><span class="p">(</span><span class="nx">client</span><span class="p">)</span><span class="si">}</span><span class="p">&gt;</span>See FAQs<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span><span class="si">}</span>
  <span class="p">&lt;/</span><span class="nc">ApolloConsumer</span><span class="p">&gt;</span>
<span class="p">);</span></code></pre></figure>

<p>Pokud bych potřeboval použít mutation, musím nejdříve do <code class="language-plaintext highlighter-rouge">ApolloClient</code> přidat <a href="https://www.apollographql.com/docs/react/essentials/local-state.html#resolvers">resolver</a>.</p>

<figure class="highlight"><pre><code class="language-jsx" data-lang="jsx"><span class="k">export</span> <span class="kd">const</span> <span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ApolloClient</span><span class="p">({</span>
  <span class="na">uri</span><span class="p">:</span> <span class="dl">""</span><span class="p">,</span>
  <span class="na">clientState</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">defaults</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">expanded</span><span class="p">:</span> <span class="kc">false</span>
    <span class="p">},</span>
    <span class="na">resolvers</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">Mutation</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">expand</span><span class="p">:</span> <span class="p">(</span><span class="nx">_</span><span class="p">,</span> <span class="nx">d</span><span class="p">,</span> <span class="p">{</span> <span class="nx">cache</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="nx">cache</span><span class="p">.</span><span class="nx">writeData</span><span class="p">({</span> <span class="na">data</span><span class="p">:</span> <span class="p">{</span> <span class="na">expanded</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}</span> <span class="p">});</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span></code></pre></figure>

<p>Potom přidám komponentu <code class="language-plaintext highlighter-rouge">Mutation</code> a předám jí mutation s direktivou <code class="language-plaintext highlighter-rouge">@client</code>. To řekne <code class="language-plaintext highlighter-rouge">apollo-link-state</code>, aby volal lokální <code class="language-plaintext highlighter-rouge">expand</code> mutation resolver pro zpracování mutation.</p>

<figure class="highlight"><pre><code class="language-jsx" data-lang="jsx"><span class="k">import</span> <span class="p">{</span> <span class="nx">Mutation</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">react-apollo</span><span class="dl">"</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">FAQ_SECTION_EXPAND</span> <span class="o">=</span> <span class="nx">gql</span><span class="s2">`
  mutation expand {
    expand @client
  }
`</span><span class="p">;</span>

<span class="p">&lt;</span><span class="nc">Mutation</span> <span class="na">mutation</span><span class="p">=</span><span class="si">{</span><span class="nx">FAQ_SECTION_EXPAND</span><span class="si">}</span><span class="p">&gt;</span>
  <span class="si">{</span><span class="nx">expand</span> <span class="o">=&gt;</span> <span class="p">&lt;</span><span class="nc">Button</span> <span class="na">onClick</span><span class="p">=</span><span class="si">{</span><span class="nx">expand</span><span class="si">}</span><span class="p">&gt;</span>See FAQs<span class="p">&lt;/</span><span class="nc">Button</span><span class="p">&gt;</span><span class="si">}</span>
<span class="p">&lt;/</span><span class="nc">Mutation</span><span class="p">&gt;</span></code></pre></figure>

<p>Toto bylo moje základní seznámení s <code class="language-plaintext highlighter-rouge">apollo-link-state</code>. V jednom z budoucích článků popíšu jak na kombinování lokálního stavu se stavem ze serveru a složitější mutations. Aplikaci používající <a href="https://codesandbox.io/s/2jvjvllr9y">přímý zápis</a> i <a href="https://codesandbox.io/s/l4mkk62k39">mutations</a> najdete na CodeSandbox.</p>

<h3 id="školení-graphql-a-apollo">Školení GraphQL a Apollo</h3>

<p>Vedu <a href="https://rousek.name/skoleni/#graphql-a-apollo">GraphQL a Apollo workshop</a>, kde si vyzkoušíme Apollo Client v praxi.</p>

</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2021/03/13/websockets-on-django-and-react/">
            Websockets on Django and React
            <small>13 Mar 2021</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2020/08/09/high-speed-request-filtering-using-cloudflare-workers/">
            Hi-speed request filtering using Cloudflare Workers
            <small>09 Aug 2020</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2020/07/16/pipenv-is-great/">
            Pipenv is great
            <small>16 Jul 2020</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

    </div>
    <!-- Fathom - beautiful, simple website analytics -->
    <script src="https://cdn.usefathom.com/script.js" data-site="NAKOBGAG" defer></script>
    <!-- / Fathom -->
  </body>
</html>
